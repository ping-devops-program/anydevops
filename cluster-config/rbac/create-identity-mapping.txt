#set user
export MKUSR=

#set user arn
usrarn=$(aws iam get-user --user-name ${MKUSR} --query 'User.Arn' --output text)

#create in configauth
USERMAP="    - userarn: ${usrarn}\n      username: ${MKUSR}\n      groups:\n        - users"

kubectl get -n kube-system configmap/aws-auth -o yaml | awk "/mapUsers: \|/{print;print \"$USERMAP\";next}1" > /tmp/aws-auth-patch.yml

kubectl patch configmap/aws-auth -n kube-system --patch "$(cat /tmp/aws-auth-patch.yml)"

#create namespace + rbac
kubectl create namespace ping-cloud-${MKUSR}

envsubst < create-user-namespace-access.yaml.subst > ${MKUSR}-access.yaml

k create -f ${MKUSR}-access.yaml
